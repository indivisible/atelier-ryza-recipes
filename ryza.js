(()=>{"use strict";function e(e,t={},n=[]){const s=document.createElement(e);for(const[e,n]of Object.entries(t))s.setAttribute(e,n);return Array.isArray(n)||(n=[n]),function(e,t){Array.isArray(t)||(t=[t]);for(const n of t)n instanceof Element?e.appendChild(n):e.appendChild(document.createTextNode(n))}(s,n),s}const t=[];function n(e,n){const s={sort:t.length,cost:e,description:n};return t.push(s),s}const s=n(0,"(base category)"),o=n(0,"(effect category)"),c=n(1,"(morph)"),i=n(1,"(named ingredient)"),r=n(1,"(ingredient)"),l=n(1,"(EV-link)");let a,f,u;function d(e,t){const n=new Set(Object.keys(a)),s={},o={};for(const e of n)s[e]=1/0,o[e]=null;for(s[e]=0;n.size;){let e=null;for(const t of n)(!e||e[1]>s[t])&&(e=[t,s[t]]);const[c,i]=e;if(n.delete(c),c==t)break;for(const[e,t]of Object.entries(a[c])){if(!n.has(e))continue;const r=i+t.cost;r<s[e]&&(s[e]=r,o[e]=c)}}const c=[];let i=t;if(o[i]||i==e)for(;i;)c.unshift(i),i=o[i];return c}let p,m=null;const g=100,h={Fire:"atelier-ryza2-fire",Ice:"atelier-ryza2-ice",Thunder:"atelier-ryza2-lightning",Air:"atelier-ryza2-wind"};let b;function y(e,t,n,s=0){const o=50,c={class:"mixfield rounded mx-auto d-block"},i={};for(const[e,t]of Object.entries(n.rings))t.ev_lv<=s&&(i[e]=t);const r=Math.min(...Object.values(i).map((e=>e.x))),l=Math.max(...Object.values(i).map((e=>e.x))),a=Math.min(...Object.values(i).map((e=>e.y))),f=[(r-1)*o-10,(a-1)*o-10,(l-r+2)*o+20,(Math.max(...Object.values(i).map((e=>e.y)))-a+2)*o+20];c.viewBox=f.join(" ");const u=(e,t)=>{const n=document.createElementNS("http://www.w3.org/2000/svg",e);for(const[e,s]of Object.entries(t))n.setAttribute(e,s.toString());return n},d=u("svg",c),p=[];for(const e of Object.values(i)){if(null===e.parent_idx)continue;const t=i[e.parent_idx],n=e.x*o,s=e.y*o,c=t.x*o,r=t.y*o;p.push(`M${n},${s}L${c},${r}`)}p&&d.appendChild(u("path",{d:p.join(""),class:"connection"}));for(const e of Object.values(i)){const t=e.x*o,n=e.y*o,s=["loop","loop-type-"+e.type,"loop-elem-"+e.element];e.is_essential&&s.push("loop-essential"),d.appendChild(u("circle",{class:s.join(" "),cx:t,cy:n,r:26}))}return d}function v(e){const t=(e.parents||[]).map((e=>m.items[e]));return Math.min(e.level,...t.map(v))}function j(e){const t=document.querySelector("#item-popup .modal-body");t.innerHTML="",t.appendChild(e),b.show()}function O(e){j(k(e))}function _(e){m.items[e]?O(m.items[e]):console.warn(`unknown popup thing: ${e}`)}function E(t,n=!0){const s={item:m.items,category:m.categories,effect:m.effects,ev_effect:m.ev_effects};let o="unknown",c=null;for(const[e,n]of Object.entries(s))if(c=n[t],c){o=e;break}if(null===c)throw`Error: ${t} not found!`;const i={class:`link-${o}`,"data-link-type":o,"data-link-tag":t};if(c.description&&(i.title=c.description),"ev_effect"==o&&(i.title=c.effects.map((e=>m.effects[e].name)).join(", ")),n&&"item"==o){i.href="#";const n=e("a",i,[c.name]);return n.addEventListener("click",(e=>{e.preventDefault(),O(m.items[t])})),n}return e("span",i,[c.name])}function k(t){const n=[],s=["Lv"+t.level,"MinLv"+v(t),"$"+t.price].map((t=>e("li",{},[t]))),o=e("div",{class:"card-body"},[e("h5",{class:"card-title"},[E(t.tag,!1)]),e("h6",{class:"card-subtitle muted"},[t.tag,e("ul",{class:"misc-info inline-list"},s)])]),c=(t,s)=>{n.push(e("dt",{class:"col-sm-3"},[t])),n.push(e("dd",{class:"col-sm-9"},s))},i=[],r=[[t.categories,""],[t.possible_categories,"optional"]];for(const[t,n]of r){const s={};n&&(s.class=n);for(const n of t)i.push(e("li",{},[e("span",s,[m.categories[n].name])]))}c("Categories",e("ul",{class:"inline-list"},i)),c("Elements",function(t){const n=[];for(const[s,o]of Object.entries(h)){const c=t.elements.includes(s),i=t.possible_elements[s],r=c||i,l=["elem-icon","icon","icon-lg"];l.push(o),l.push(r?"elem-active":"elem-inactive");const a=m.elements[s];let f={title:a};r||(f.title="No "+a),i&&(f={class:"optional",title:`${a} (from ${i} effect)`}),n.push(e("li",f,[e("span",{class:l.join(" ")},[])]))}let s=""+t.element_value;return t.add_element_value>0&&(s+="+"+t.add_element_value),[e("span",{},[s]),e("ul",{class:"elements"},n)]}(t));const l=[];for(const e of Object.values(t.effects)){const t=Object.keys(e);if(!t.length)break;t.sort(((e,t)=>parseInt(t)-parseInt(e)));const n=e[t[0]].effect;l.push(m.effects[n])}if(l.length){l.sort(((e,t)=>e.name_id-t.name_id));const t=l.map((t=>e("li",{},[E(t.tag)])));c("Effects",e("ul",{class:"inline-list effects"},t))}if(t.ingredients.length){const n=t.ingredients.map((t=>e("li",{},[E(t)])));c("Ingredients",e("ul",{class:"inline-list ingredients"},n));const s=function(e){let t=e,n=0;return e.ev_base&&(t=m.items[e.ev_base],n=1),t.recipe&&t.recipe.mixfield?[e,t.recipe,t.recipe.mixfield,n]:null}(t);if(s){const t=e("button",{class:"btn btn-primary"},"Show");c("Loops",t),t.addEventListener("click",(()=>function(...t){j(e("div",{class:"mixfield-container"},[y(...t)]))}(...s)))}}const a=[];let f=t.parents;for(;f&&f.length;){f.length>1&&console.warn(`Too many parents for ${t.tag}`);const e=m.items[f[0]];a.unshift(e),f=e.parents}if(a.length){const t=a.map((t=>e("li",{},E(t.tag))));c("Parents",e("ul",{class:"inline-list parents"},t))}const u=t.children.map((t=>e("li",{},[E(t)])));if(u.length&&c("Children",e("ul",{class:"inline-list children"},u)),t.ev_base){const n=m.items[t.ev_base],s=[n,m.items[n.recipe.ev_extend_mat]].map((t=>e("li",{},[E(t.tag)])));c("EV-link from",e("ul",{class:"inline-list"},s))}t.gathering&&c("Gather",t.gathering),t.shop_data&&c("Shop",t.shop_data),t.seed&&c("From seed",E(t.seed));const d=t.forge_effects.map((t=>e("li",{},[E(t[t.length-1].forged_effect)])));d.length&&c("Forging",e("ul",{class:"inline-list effects"},d));const p=[];for(const n of Object.values(t.ev_effects))for(let t=n.length-1;t>=0;t--){const s=n[t];m.ev_effects[s].effects.length&&p.push(e("li",{},[E(s)]))}p.length&&c("EV effects",e("ul",{class:"inline-list"},p));const g=["start"];(t.recipe||t.ev_base)&&g.push("goal");const b=g.map((n=>{const s=e("button",{class:"btn btn-primary m-1"},["Set as "+n]);return s.addEventListener("click",(()=>L(n,t))),s}));return c("Chain",e("div",{},b)),e("div",{class:"card","data-tag":t.tag},[o,e("dl",{class:"card-body row"},n)])}let w=null,x=null;function L(e,t){"start"==e?w=t:x=t,C()}function C(){const t=document.getElementById("chain-container");if(document.getElementById("chain-results").innerHTML="",!m||!w&&!x)return void(t.style.display="none");t.style.display="block";const n=document.getElementById("chain-start"),s=document.getElementById("chain-goal"),o=[[n,w,"start"],[s,x,"goal"]];for(const[t,n,s]of o)if(n){const o=e("button",{class:"btn btn-primary"},[n.name]),c=e("button",{class:"btn btn-danger",title:"Remove"},["🗑️"]);o.addEventListener("click",(()=>O(n))),c.addEventListener("click",(()=>{L(s,null)}));const i=e("div",{class:"btn-group"},[o,c]);t.innerHTML="",t.appendChild(i)}else t.innerText="(none)";document.getElementById("find-chains-button").disabled=!w||!x}function I(e,t){if(m.categories.hasOwnProperty(e.tag))return["➡"];if(m.categories.hasOwnProperty(t.tag))return["➡"];const n=function(e,t){return a[e][t].description}(e.tag,t.tag);return[n,"➡"]}function B(){if(!w||!x)return void alert("A chain endpoint is missing!");const t=document.getElementById("chain-results");t.innerHTML="";const n=function(e,t,n,s=5){if(e.categories.hasOwnProperty(t)&&(a[t]=u[t]),e.categories.hasOwnProperty(n)){a[n]={};for(const[e,t]of Object.entries(f[n]))a[e][n]=t}const o=function(e,t,n=5){const s=[d(e,t)];if(!s[0].length)return[];const o=[];let c={},i={};for(let e=1;e<n;e++){const e=s[s.length-1];for(let n=0;n<e.length-2;n++){const r=e[n],l=e.slice(0,n+1);for(const e of s)if(l.join()==e.slice(0,n+1).join()){const t=[e[n],e[n+1]];i.hasOwnProperty(t.toString())||(i[t.toString()]=[t,a[t[0]][t[1]]]),delete a[t[0]][t[1]]}for(const e of l.slice(0,-1))c.hasOwnProperty(e)||(c[e]=a[e]),a[e]={};const f=d(r,t);for(const[e,t]of Object.entries(c))a[e]=t;for(const[e,t]of Object.values(i))a[e[0]][e[1]]=t;if(c={},i={},f.length){const e=l.concat(f.splice(1)),t=e.join();let n=!1;for(const e of o)if(t==e[1]){n=!0;break}n||o.push([e,t])}}if(!o.length)break;let n=1/0,r=null;for(let e=0;e<o.length;e++){const t=o[e][0];let s=0,c=t[0];for(const e of t.slice(1))s+=a[c][e].cost,c=e;s<n&&(n=s,r=e)}s.push(o.splice(r,1)[0][0])}return s}(t,n,s);if(e.categories.hasOwnProperty(t)&&delete a[t],e.categories.hasOwnProperty(n)){delete a[n];for(const e of Object.keys(f[n]))delete a[e][n]}return o}(m,w.tag,x.tag);n.length||t.appendChild(e("li",{class:"list-group-item text-danger"},["No chains found!"]));for(const s of n){const n=[];let o=null;for(const t of s){const s=m.items[t]||m.categories[t];o&&n.push(...I(o,s));const c=e("button",{class:"btn btn-secondary m-2"},[s.name]);n.push(c),c.addEventListener("click",(()=>_(t))),o=s}t.appendChild(e("li",{class:"list-group-item p-2 d-flex flex-wrap align-items-center justify-contents-center"},n))}}function M(){if(!m)return;console.debug("ready");const e=document.getElementById("result-count");e.innerText="Searching...";const t=e=>document.getElementById(e),n=t("name-input").value.trim().toUpperCase(),s=t("effect-input").value.trim().toUpperCase(),o=[],c=document.getElementById("results"),i=[];c.innerHTML="";for(const e of document.querySelectorAll("input.element"))e.checked&&i.push(e.value);e:for(const[e,t,r]of p){if(n){let e=!1;for(const s of t)if(s.includes(n)){e=!0;break}if(!e)continue e}if(s){let e=!1;for(const t of r)if(t.includes(s)){e=!0;break}if(!e)continue e}for(const t of i)if(!e.elements.includes(t)&&!e.possible_elements[t])continue e;if(o.push(e),c.appendChild(k(e)),o.length>=g){console.warn("maximum number of results reached");break}}o.length>=g?e.innerText=`${o.length}+ found`:e.innerText=`${o.length} found`,console.debug(`found ${o.length} items`)}function $(){const e=document.getElementById("game-input");m=null,L("start",null),L("goal",null),C(),fetch(e.value).then((async e=>{m=await e.json(),m&&(function(){p=[];for(const e of Object.values(m.items)){const t=[];{const n=[];n.push(e.name.toUpperCase()),n.push(e.tag);const s=e.categories.concat(e.possible_categories);for(const e of s)n.push(e),n.push(m.categories[e].name.toUpperCase());t.push(n)}{const n=[];for(const t of Object.values(e.effects))for(const e of Object.values(t))n.push(e.effect),n.push(m.effects[e.effect].name.toUpperCase());for(const t of e.forge_effects)for(const e of t)n.push(e.forged_effect),n.push(m.effects[e.forged_effect].name.toUpperCase());for(const t of Object.values(e.ev_effects))for(const e of t){n.push(e);const t=m.ev_effects[e];n.push(t.name.toUpperCase());for(const e of t.effects)n.push(e),n.push(m.effects[e].name.toUpperCase())}t.push(n)}p.push([e,t[0],t[1]])}}(),M(),function(e){a={},f={},u={};const t=(e,t,n,s)=>{(!e[t][n]||e[t][n].sort>s.sort)&&(e[t][n]=s)};for(const t of Object.keys(e.items))a[t]={};for(const t of Object.keys(e.categories))f[t]={},u[t]={};for(const n of Object.values(e.items)){for(const e of n.categories)t(f,e,n.tag,s);for(const e of n.possible_categories)t(f,e,n.tag,o);for(const e of n.children)t(a,n.tag,e,c);n.ev_base&&t(a,n.ev_base,n.tag,l);for(const s of n.ingredients)e.categories.hasOwnProperty(s)?t(u,s,n.tag,i):t(a,s,n.tag,i)}for(const[n,s]of Object.entries(e.categories)){const e=Object.keys(u[n]),o=Object.keys(f[n]);for(const n of o)for(const o of e){const e={...r,description:s.name};t(a,n,o,e)}}}(m))}))}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("game-input");b=new bootstrap.Modal(document.getElementById("item-popup")),e.addEventListener("change",$),$();for(const e of document.querySelectorAll("#search-bar input"))e.addEventListener("input",M);document.getElementById("find-chains-button").addEventListener("click",B),document.getElementById("chain-swap-button").addEventListener("click",(()=>{[x,w]=[w,x],C()})),document.getElementById("clear-chains-button").addEventListener("click",(()=>{C()}))}))})();